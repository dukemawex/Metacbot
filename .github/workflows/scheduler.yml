name: Metaculus Tournament Sentinel

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    env:
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
      EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      LIVE_MODE: ${{ vars.LIVE_MODE || 'false' }}
      STRICT_OPEN_WINDOW: ${{ vars.STRICT_OPEN_WINDOW || 'false' }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      - name: Run bot
        run: python -m src.main
      - name: Upload data artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metacbot-data
          path: data/
      - name: Commit data updates
        if: always()
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add data/
          git diff --cached --quiet || (git commit -m "Update sentinel data" && git push)
      - name: Optional Slack alert
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Metacbot scheduler failed"}' "$SLACK_WEBHOOK_URL"
